#include "printf.h"
#include "peripherals/spi.h"
#include <stdint.h>

#define LOGO_WIDTH  120  // 15 bytes * 8 bits = 120 pixels
#define LOGO_HEIGHT 61   // 61 rows

void spi_write_byte(unsigned char data) {
    // Clear FIFO and activate transfer
    *CS |= (1 << 7);   // Set TA (Transfer Active)
    
    // Wait for TXD (can accept data)
    while (!(*CS & (1 << 18)));
    
    // Write data to FIFO
    *FIFO = data;
    
    // Wait for DONE (transfer complete)
    while (!(*CS & (1 << 16)));
    
    // Clear TA
    *CS &= ~(1 << 7);
    printf("spi_write_byte\n");
}
void oled_command(unsigned char cmd) {
    oled_gpiocmd();  // Set GPIO24 LOW (command mode)
    spi_write_byte(cmd);
    //printf("oled_command\n");
}

void oled_data(unsigned char data) {
    oled_gpiodata();  // Set GPIO24 HIGH (data mode)
    spi_write_byte(data);
    //printf("oled_data\n");
}

// OLED Logo Display Code


// Your logo data (skipping the color palette - first 8 bytes)
const uint8_t logo_bitmap[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x3f, 0xff, 0xff, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 
    0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 
    0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 
    0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 
    0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 
    0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 
    0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xdf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 
    0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xef, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 
    0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 
    0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfb, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 
    0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfd, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 
    0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 
    0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 
    0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 
    0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xbf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 
    0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x9f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 
    0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x8f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 
    0x7f, 0x80, 0x7e, 0x00, 0xff, 0xc0, 0x00, 0x00, 0x0f, 0xff, 0xff, 0xe0, 0x3f, 0xff, 0xe0, 
    0x7c, 0x00, 0x7e, 0x00, 0x3f, 0xc0, 0x00, 0x00, 0x03, 0xff, 0xff, 0xe0, 0x1f, 0xff, 0xe0, 
    0x7c, 0x00, 0x7e, 0x00, 0x3f, 0xc0, 0x00, 0x00, 0x03, 0xff, 0xff, 0xc0, 0x0f, 0xff, 0xe0, 
    0x78, 0x00, 0x7e, 0x00, 0x1f, 0xc0, 0x00, 0x00, 0x01, 0xff, 0xff, 0x80, 0x0f, 0xff, 0xe0, 
    0x78, 0x00, 0x7e, 0x00, 0x1f, 0xc0, 0x00, 0x00, 0x01, 0xff, 0xff, 0x80, 0x07, 0xff, 0xe0, 
    0x78, 0x07, 0xff, 0xf0, 0x1f, 0xea, 0xaa, 0xa0, 0x01, 0xff, 0xff, 0x00, 0x07, 0xff, 0xe0, 
    0x78, 0x0f, 0xff, 0xf0, 0x1f, 0xff, 0xff, 0xf3, 0x81, 0xff, 0xff, 0x00, 0x03, 0xff, 0xe0, 
    0x78, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf3, 0x81, 0xff, 0xfe, 0x00, 0x01, 0xff, 0xe0, 
    0x78, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf3, 0x81, 0xff, 0xfe, 0x03, 0x01, 0xff, 0xe0, 
    0x78, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf3, 0x81, 0xff, 0xfc, 0x03, 0x00, 0xff, 0xe0, 
    0x78, 0x00, 0x7e, 0x01, 0xff, 0xff, 0xff, 0xf1, 0x01, 0xff, 0xf8, 0x07, 0x80, 0xff, 0xe0, 
    0x78, 0x00, 0x7e, 0x00, 0x3f, 0xea, 0xaa, 0xa0, 0x01, 0xff, 0xf8, 0x0f, 0x80, 0x7f, 0xe0, 
    0x7c, 0x00, 0x7e, 0x00, 0x1f, 0xc0, 0x00, 0x00, 0x03, 0xff, 0xf0, 0x0f, 0xc0, 0x7f, 0xe0, 
    0x7c, 0x00, 0x7e, 0x00, 0x1f, 0xc0, 0x00, 0x00, 0x07, 0xff, 0xf0, 0x1f, 0xc0, 0x3f, 0xe0, 
    0x7f, 0x00, 0x7e, 0x00, 0x1f, 0xc0, 0x00, 0x00, 0x07, 0xff, 0xe0, 0x1f, 0xe0, 0x3f, 0xe0, 
    0x7f, 0xff, 0xff, 0xe0, 0x1f, 0xc0, 0x00, 0x00, 0x03, 0xff, 0xe0, 0x3f, 0xf0, 0x1f, 0xe0, 
    0x3f, 0xff, 0xff, 0xf0, 0x1f, 0xc0, 0x00, 0x00, 0x01, 0xff, 0xc0, 0x7f, 0xf0, 0x1f, 0xe0, 
    0x3f, 0xff, 0xff, 0xf0, 0x1f, 0xc0, 0x7f, 0xe1, 0x01, 0xff, 0xc0, 0x7f, 0xf8, 0x0f, 0xe0, 
    0x38, 0x1f, 0xff, 0xf0, 0x1f, 0xc0, 0x7f, 0xe3, 0x81, 0xff, 0x80, 0xff, 0xf8, 0x07, 0xe0, 
    0x38, 0x0f, 0xff, 0xf0, 0x1f, 0xc0, 0x7f, 0xe3, 0x81, 0xff, 0x00, 0xff, 0xfc, 0x07, 0xe0, 
    0x18, 0x00, 0x7e, 0x00, 0x1f, 0xc0, 0x7f, 0xe3, 0x81, 0xff, 0x01, 0xff, 0xfc, 0x03, 0xe0, 
    0x18, 0x00, 0x7e, 0x00, 0x1f, 0xc0, 0x7f, 0xc3, 0x81, 0xfe, 0x01, 0xff, 0xfe, 0x03, 0xe0, 
    0x0c, 0x00, 0x7e, 0x00, 0x1f, 0xc0, 0x7f, 0xc3, 0x81, 0xfe, 0x03, 0xff, 0xff, 0x01, 0xe0, 
    0x0c, 0x00, 0x7e, 0x00, 0x3f, 0xc0, 0x7f, 0x87, 0x81, 0xfc, 0x07, 0xff, 0xff, 0x00, 0xe0, 
    0x07, 0x00, 0x7e, 0x00, 0xff, 0xc0, 0x7f, 0x87, 0x81, 0xfc, 0x07, 0xff, 0xff, 0x80, 0xe0, 
    0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 
    0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 
    0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 
    0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 
    0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 
    0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 
    0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 
    0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 
    0x00, 0x07, 0xff, 0xff, 0xff, 0xff, 0x80, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 
    0x00, 0x03, 0xff, 0xff, 0xff, 0xfe, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 
    0x00, 0x01, 0xff, 0xff, 0xff, 0xfc, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 
    0x00, 0x00, 0x7f, 0xff, 0xff, 0xf0, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 
    0x00, 0x00, 0x0f, 0xff, 0xff, 0x80, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 
    0x00, 0x00, 0x03, 0xff, 0xfe, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 
    0x00, 0x00, 0x00, 0x15, 0x40, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};



// Function to display the logo on OLED
void display_logo(void) {
    // Initialize OLED first
    oled_init();
    printf("oled_display\n");
    // Clear display
    oled_clear_screen();
    printf("oled_display\n");
    // Set addressing mode to horizontal
    oled_command(0x20);  // Set Memory Addressing Mode
    oled_command(0x00);  // Horizontal Addressing Mode
    
    // Set column address (center the logo if your display is 128 pixels wide)
    oled_command(0x21);  // Set Column Address
    oled_command(0x04);  // Start column (128-120)/2 = 4 for centering
    oled_command(0x7B);  // End column (4+120-1 = 123)
    
    // Set page address (if your display is 64 pixels high)
    oled_command(0x22);  // Set Page Address  
    oled_command(0x00);  // Start page 0
    oled_command(0x07);  // End page 7 (64/8-1 = 7)
    
    // Send the bitmap data
    for (int i = 0; i < sizeof(logo_bitmap); i++) {
        oled_data(logo_bitmap[i]);
    }
}

// Helper function to clear screen
void oled_clear_screen(void) {
    oled_command(0x20);  // Set Memory Addressing Mode
    oled_command(0x00);  // Horizontal Addressing Mode
    
    oled_command(0x21);  // Set Column Address
    oled_command(0x00);  // Start column 0
    oled_command(0x7F);  // End column 127
    
    oled_command(0x22);  // Set Page Address
    oled_command(0x00);  // Start page 0
    oled_command(0x07);  // End page 7
    
    // Send zeros to clear all pixels
    for (int i = 0; i < 128 * 8; i++) {
        oled_data(0x00);
    }
    printf("oled_clear_screen\n");
}

// Basic OLED initialization (SSD1306 example)
void oled_init(void) {
    // Reset sequence (if you have RST pin connected)
    // gpio_set_low(RST_PIN);
    // delay_ms(10);
    // gpio_set_high(RST_PIN);
    // delay_ms(10);
    
    oled_command(0xAE); // Display off
    oled_command(0xD5); // Set display clock divide ratio/oscillator frequency
    oled_command(0x80); // Set divide ratio
    oled_command(0xA8); // Set multiplex ratio
    oled_command(0x3F); // 1/64 duty
    oled_command(0xD3); // Set display offset
    oled_command(0x00); // No offset
    oled_command(0x40); // Set start line address
    oled_command(0x8D); // Charge pump setting
    oled_command(0x14); // Enable charge pump
    oled_command(0x20); // Set Memory Addressing Mode
    oled_command(0x00); // Horizontal Addressing Mode
    oled_command(0xA1); // Set segment re-map (A0/A1)
    oled_command(0xC8); // Set COM output scan direction
    oled_command(0xDA); // Set COM pins hardware configuration
    oled_command(0x12); 
    oled_command(0x81); // Set contrast control
    oled_command(0xCF); 
    oled_command(0xD9); // Set pre-charge period
    oled_command(0xF1); 
    oled_command(0xDB); // Set VCOMH deselect level
    oled_command(0x40); 
    oled_command(0xA4); // Entire display on (resume to RAM content display)
    oled_command(0xA6); // Set normal display
    oled_command(0xAF); // Display on
    printf("oled_init\n");
}

void spi_init(){
    spi_gpio();
// Set clock divider (adjust speed as needed)
*CLK = 256;  // Start with slower speed, can optimize later

// Configure SPI0 Control Register for standard mode
     *CS = (0 << 7) |     // LOSSI = 0 (standard SPI mode)
           (0 << 6) |     // REN = 0 (no read enable needed)
           (0 << 5) |     // LEN = 0 (not using LOSSI)
           (0 << 4) |     // CPHA = 0 (clock phase)
           (0 << 3) |     // CPOL = 0 (clock polarity)
           (0 << 2) |     // CLEAR = 0 (don't clear FIFO yet)
           (0 << 1) |     // CSPOL = 0 (CS active low)
           (0 << 0);      // CS = 0 (select chip 0)
    printf("spi_init\n");
}